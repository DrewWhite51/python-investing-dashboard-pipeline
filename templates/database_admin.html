{% extends "base.html" %}

{% block title %}Database Admin - Investment News Pipeline{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
<style>
    .sql-editor {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        min-height: 200px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f8f9fa;
    }
    
    .query-result {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .table-preview {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .query-example {
        background: #e9ecef;
        border-left: 4px solid #007bff;
        padding: 0.5rem;
        margin: 0.5rem 0;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        cursor: pointer;
        border-radius: 0 4px 4px 0;
    }
    
    .query-example:hover {
        background: #dee2e6;
    }
    
    .schema-table {
        font-size: 0.9rem;
    }
    
    .column-type {
        color: #6c757d;
        font-style: italic;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .table-stats {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Database Stats -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ db_stats.total_sources }}</h3>
                <small>News Sources</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ db_stats.total_urls }}</h3>
                <small>Collected URLs</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ db_stats.total_batches }}</h3>
                <small>Collection Batches</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ db_stats.unique_domains }}</h3>
                <small>Unique Domains</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Database Schema -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table text-primary me-2"></i>
                    Database Schema
                </h5>
            </div>
            <div class="card-body p-0">
                {% for table_name, columns in schema.items() %}
                <div class="accordion-item">
                    <div class="accordion-header">
                        <button class="btn btn-link w-100 text-start p-3" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#table-{{ loop.index }}">
                            <i class="fas fa-table me-2"></i>
                            <strong>{{ table_name }}</strong>
                            <span class="badge bg-secondary ms-2">{{ columns|length }} columns</span>
                        </button>
                    </div>
                    <div id="table-{{ loop.index }}" class="collapse show">
                        <div class="px-3 pb-2">
                            <table class="table table-sm schema-table">
                                {% for column in columns %}
                                <tr>
                                    <td><strong>{{ column.name }}</strong></td>
                                    <td class="column-type">{{ column.type }}</td>
                                    {% if column.pk %}
                                    <td><span class="badge bg-warning">PK</span></td>
                                    {% elif column.fk %}
                                    <td><span class="badge bg-info">FK</span></td>
                                    {% else %}
                                    <td></td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </table>
                            <button class="btn btn-outline-primary btn-sm" 
                                    onclick="previewTable('{{ table_name }}')">
                                <i class="fas fa-eye me-1"></i>
                                Preview Data
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    onclick="insertQuery('SELECT * FROM {{ table_name }} LIMIT 10;')">
                                <i class="fas fa-code me-1"></i>
                                Sample Query
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Quick Query Examples -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb text-warning me-2"></i>
                    Quick Query Examples
                </h6>
            </div>
            <div class="card-body">
                <div class="query-example" onclick="insertQuery('SELECT name, url, collection_count, avg_articles_found FROM news_sources ORDER BY collection_count DESC;')">
                    Show source performance
                </div>
                <div class="query-example" onclick="insertQuery('SELECT domain, COUNT(*) as count FROM collected_urls GROUP BY domain ORDER BY count DESC LIMIT 10;')">
                    Top domains by URL count
                </div>
                <div class="query-example" onclick="insertQuery('SELECT ns.name, COUNT(cu.id) as urls_collected FROM news_sources ns LEFT JOIN collected_urls cu ON ns.id = cu.source_id GROUP BY ns.id ORDER BY urls_collected DESC;')">
                    URLs collected per source
                </div>
                <div class="query-example" onclick="insertQuery('SELECT DATE(collected_at) as date, COUNT(*) as urls FROM collected_urls GROUP BY DATE(collected_at) ORDER BY date DESC;')">
                    Daily collection stats
                </div>
                <div class="query-example" onclick="insertQuery('SELECT cb.*, COUNT(cu.id) as urls_in_batch FROM collection_batches cb LEFT JOIN collected_urls cu ON cb.batch_id = cu.collection_batch_id GROUP BY cb.batch_id ORDER BY cb.created_at DESC;')">
                    Collection batch details
                </div>
                <div class="query-example" onclick="insertQuery('SELECT * FROM collected_urls WHERE used_in_pipeline = 1 ORDER BY collected_at DESC LIMIT 20;')">
                    URLs used in pipeline
                </div>
            </div>
        </div>
    </div>

    <!-- SQL Query Interface -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-code text-success me-2"></i>
                    SQL Query Editor
                </h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearQuery()">
                        <i class="fas fa-trash me-1"></i>
                        Clear
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="executeQuery()">
                        <i class="fas fa-play me-1"></i>
                        Execute Query
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form id="queryForm" method="POST" action="/admin/database/query">
                    <textarea id="sqlQuery" name="query" class="form-control sql-editor" 
                             placeholder="Enter your SQL query here...">SELECT * FROM news_sources LIMIT 10;</textarea>
                </form>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Read-only queries only. Use standard SQLite syntax.
                    </small>
                </div>
            </div>
        </div>

        <!-- Query Results -->
        <div id="queryResults" class="card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-table text-info me-2"></i>
                    Query Results
                </h6>
                <div>
                    <span id="resultCount" class="badge bg-info"></span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportResults()">
                        <i class="fas fa-download me-1"></i>
                        Export CSV
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="resultsContainer" class="query-result"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
<script>
    function insertQuery(query) {
        document.getElementById('sqlQuery').value = query;
    }
    
    function clearQuery() {
        document.getElementById('sqlQuery').value = '';
    }
    
    function executeQuery() {
        const query = document.getElementById('sqlQuery').value.trim();
        if (!query) {
            alert('Please enter a SQL query');
            return;
        }
        
        // Show loading
        const resultsDiv = document.getElementById('queryResults');
        const resultsContainer = document.getElementById('resultsContainer');
        resultsDiv.style.display = 'block';
        resultsContainer.innerHTML = '<div class="p-3 text-center"><i class="fas fa-spinner fa-spin"></i> Executing query...</div>';
        
        // Execute query via AJAX
        fetch('/admin/database/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'query=' + encodeURIComponent(query)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResults(data.results, data.columns);
            } else {
                resultsContainer.innerHTML = `<div class="p-3 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>${data.error}</div>`;
            }
        })
        .catch(error => {
            resultsContainer.innerHTML = `<div class="p-3 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${error}</div>`;
        });
    }
    
    function displayResults(results, columns) {
        const container = document.getElementById('resultsContainer');
        const countBadge = document.getElementById('resultCount');
        
        if (!results || results.length === 0) {
            container.innerHTML = '<div class="p-3 text-muted"><i class="fas fa-info-circle me-2"></i>No results found</div>';
            countBadge.textContent = '0 rows';
            return;
        }
        
        countBadge.textContent = `${results.length} row${results.length !== 1 ? 's' : ''}`;
        
        let html = '<div class="table-responsive"><table class="table table-striped table-hover mb-0">';
        
        // Header
        html += '<thead class="table-dark"><tr>';
        columns.forEach(col => {
            html += `<th>${col}</th>`;
        });
        html += '</tr></thead>';
        
        // Body
        html += '<tbody>';
        results.forEach(row => {
            html += '<tr>';
            columns.forEach(col => {
                let value = row[col];
                if (value === null) value = '<em class="text-muted">NULL</em>';
                else if (typeof value === 'string' && value.length > 100) {
                    value = value.substring(0, 100) + '...';
                }
                html += `<td>${value}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table></div>';
        
        container.innerHTML = html;
    }
    
    function previewTable(tableName) {
        insertQuery(`SELECT * FROM ${tableName} LIMIT 10;`);
        executeQuery();
    }
    
    function exportResults() {
        // Simple CSV export
        const table = document.querySelector('#resultsContainer table');
        if (!table) return;
        
        let csv = '';
        const rows = table.querySelectorAll('tr');
        
        rows.forEach(row => {
            const cols = row.querySelectorAll('td, th');
            const csvRow = Array.from(cols).map(col => `"${col.textContent.replace(/"/g, '""')}"`).join(',');
            csv += csvRow + '\n';
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `query_results_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
</script>
{% endblock %}